## 示例

**以一个极简的room组件为例：**

其中`@home`映射`/src`目录，为唯一根目录

### 配置路由

配置路由，异步引入模块

`/src/router/RouterConfig`

``` 
const RouterConfig = [{
	path: '/room',
	exact: true,
	component: lazy(() => import('@home/page/room')),
}] 
``` 

### 创建模块

`/src/page`

一个完整的模块应该包含这些文件
```
├─app				实例化模块
├─controllers		reducer
├─epics			  epic
├─modules			component
├─services		   service
└─index.js		   模块入口，用于导出模块/渲染模块
```
reducer，epic，service相辅相成，在不同场景下可以按需使用，可能都会用到，也可能都用不到

#### 创建module

常规react + redux写法
- connect默认省略mapStateToProps和mapDispatchToProps参数
- log装饰器打印非箭头函数
- Launcher加载器，用于加载文件
- Launcher.Service注入service方法（异步请求建议统一走rx）
- multipleDispatch为另一个示例模块，用于展示如何挂载和卸载模块
- 代理redux dispatch方法，省略action文件，通过type识别reducer和epic

```
import { Component } from 'react'
import connect from '@home/core/connect'
import { log } from '@home/core/log'
import Launcher from '@home/core/launcher'
import demoService from '../services/demo'
import multipleDispatch from '@home/pages/multipleDispatch'
import loading from '@home/core/HOC/loading'
import Loading from '@home/components/Loading'

export default
@loading({ debounce: 300 })
@connect()
@log
class AAA extends Component {

	@Launcher.Service(demoService)
	demoService

	constructor(props) {
		super(props)
	}

	componentDidMount() {
		// service用于处理异步事件完成后的动作
		this.demoService
			.getInfo()
			.subscribe((res) => {
				console.log('service finished', res)
			})
	}

	pingEpic = () => {
		this.props.dispatch({
			type: 'list/fetchList',
			payload: {
				id: (this.props.list?.login || 0) + 1,
			},
		});
	}

	mount = () => {
		this.multipleDispatch = multipleDispatch.$mount();
	}

	unmount = () => {
		this.multipleDispatch.$unmount();
	}

	render() {
		return <Loading loading={this.props.$loading}>
			<span>room</span>
			<div>testStr: {this.props.testStr}</div>
			<button onClick={this.pingEpic}>click</button>
			<span> </span>
			<button onClick={this.mount}>mount</button>
			<span> </span>
			<button onClick={this.unmount}>unmount</button>
			<div>id: {this.props.list?.login}</div>
			<div>loading: {this.props.$loading.toString()}</div>
		</Loading>
	}
}
```

#### 创建epic

- http$: rx请求数据流
- namespace：命名空间，与dispatch时传入的type的第一个值对应
- fetchList：拉取列表数据，与dispatch时传入的type的第二个值对应
- epic 的基本原则： action入，action出，此处的action即 { type: xxx, payload: ... }

``` 
import { mergeMap, map } from 'rxjs/operators'
import http$ from '@home/util/http'
import Epic from '@home/core/baseClass/Epic';

export default class ListEpic extends Epic{
	// epic命名空间,与controller ns 对应
	namespace = 'list';

	fetchList(action$) {
		return action$.pipe(
			mergeMap(({ payload }) =>
				http$.getJSON(`https://api.github.com/users/${payload.id}?param=${payload.id}`).pipe(
					map(response => {
						return {
							type: 'list/showList',
							payload: response,
						}
					})
				)
			)
		)
	}

}
 
``` 

#### 创建controller

- 即reducer，处理无副作用的方法
- namespace：命名空间，与dispatch时传入的type的第一个值对应
- initial：初始化props，在module实例化时传入
- showList：展示数据，与dispatch时传入的type的第二个值对应

```
import Controller from '@home/core/baseClass/Controller';

export default class DemoController extends Controller {

	namespace = 'list';

	initial = {
		a: 1,
		b: 2,
	}

	showList({ payload }, state) {
		return payload;
	}
}
```

#### 创建service

- Launcher.store：注入redux store，可以调用store.dispatch更新其他模块

``` 
import Service from '@home/core/baseClass/Service';
import http$ from '@home/util/http'
import Launcher from '@home/core/launcher';

export default class DemoService extends Service {
	@Launcher.store('roomApp') store;
	@Launcher.store() stores;

	getInfo() {
		return http$.getJSON(`https://api.github.com/users/123`)
	}
}
 
``` 

#### 创建app

- lazy用于异步加载组件，一般其实也没必要，除非弹窗等点击展示的模块影响页面加载速度时可用
- 引入各个文件，引入日志中间件，通过Launcher.createApp创建模块，createApp方法返回一个模块类
- name：模块名称必须唯一，跨模块通信会依据此名称搜寻对应模块
- storeFactory：Launcher.createStore用于创建redux store，支持middleware，enhancer
- component：modules，即react组件

``` 
import { lazy } from 'react'
import Launcher from '@home/core/launcher';
import loggerMiddleware from '@home/middlewares/logger';

import epics from '../epics';
import reducers from '../controllers';
// import PageEntry from '../modules';

const PageEntry = lazy(() => import('../modules'))

export default Launcher.createApp({
    name: 'roomApp',    //  应用名称，每个应用唯一
    storeFactory() {
        const storeProps = {
            preloadedState: window.__INITIAL_STATE__,
            middlewares: [loggerMiddleware],
            epics,
            reducers,
        }
        const store = Launcher.createStore(storeProps);
        return store;
    },
    component: PageEntry,
}); 
``` 

#### 创建index.js

- 实例化模块
- getMountableComponent：生成模块的react组件
- module：react组件
- module提供$mount（直接挂载），$cloneApp（克隆模块）方法
- 克隆的模块与原模块相互独立，如果需要复用数据同步的原模块请直接使用原模块。

``` 
import Launcher from '@home/core/launcher';
import roomApp from './app/index';

// 直接实例化组件，不可以$cloneApp
// const app = new roomApp()
// const module = Launcher.getMountableComponent(app);

// 不直接实例化组件，可以$cloneApp
const module = Launcher.getMountableComponent(roomApp, {});

// module.$mount({testStr: 123123})

export default module; 
``` 

### 运行项目


``` 
npm start
浏览器查看效果
``` 



